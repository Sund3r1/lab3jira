name: Bad CI/CD Pipeline Example

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
    
    - name: Set up JDK
      uses: actions/setup-java@v2
      with:
        java-version: '11'
    
    # Плохая практика: нет кэширования зависимостей
    - name: Build with Maven
      run: |
        echo "Building application..."
        mvn clean compile
        
    # Плохая практика: тег latest
    - name: Build Docker image
      run: |
        docker build -t myapp:latest .
        echo "Built image: myapp:latest"
        
    # Плохая практика: хардкод пароля (даже если в секретах)
    - name: Push to Docker Hub
      env:
        DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
      run: |
        docker login -u myuser -p "$DOCKER_PASSWORD"
        docker push myapp:latest
        
    - name: Run tests
      run: |
        echo "Running tests..."
        mvn test
        
        # Плохая практика: зависимость от внешнего сервиса
        curl -f https://httpbin.org/status/200 || echo "External service check failed"
        
        # Плохая практика: искусственная задержка
        sleep 60
        
    # Плохая практика: прямой деплой в production без проверок
    - name: Deploy to Production
      env:
        KUBECONFIG: ${{ secrets.KUBECONFIG }}
      run: |
        echo "Deploying to production..."
        
        # Использование latest тега
        sed 's|{{IMAGE}}|myapp:latest|g' k8s/production/deployment.yaml | kubectl apply -f -
        
        # Нет health check
        echo "Deployment completed (maybe?)"
